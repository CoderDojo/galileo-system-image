machine:
  environment:
    BSP_VERSION: 1.0.3
    BSP_URL: http://downloadmirror.intel.com/23197/eng/Board_Support_Package_Sources_for_Intel_Quark_v1.0.1.7z
    BSP: /tmp/bsp
    GALILEO_PATCHES: http://downloadmirror.intel.com/24272/eng/BSP-Patches-and-Build_Instructions.1.0.3.tar.bz2
    SSTATE_CACHE: /tmp/sstate-cache

-post: 
## Configure git
    - git config --global user.email "not.my@email.com"
    - git config --global user.name "Alan Donnelly"

checkout:
  post:
    - mkdir -p /tmp/bsp
#    - sudo mount --bind /home/travis/build/CoderDojo/galileo-system-image /tmp/bsp

dependencies:
  override:
## Update system packages
    - sudo apt-get install -y build-essential gcc-4.6-base gcc-4.6-multilib p7zip-full diffstat texinfo gawk chrpath file
    - git --version
    - gcc --version

## Download and setup the Quark BSP 
    - wget $BSP_URL -O $BSP/$(basename $BSP_URL)
    - 7z x -o$BSP $BSP/$(basename $BSP_URL)
#    - sha1sum -c sha1sum.txt
    - tar -C $BSP -xkvf $BSP/meta-clanton_*.tar.gz
    - cd $BSP/meta-clanton_* && ./setup.sh

## Download and extract Galileo patches
    - wget $GALILEO_PATCHES -O $BSP/$(basename $GALILEO_PATCHES)
    - tar -C $BSP -xkvf $BSP/$(basename $GALILEO_PATCHES)

  cache_directories:
    - /tmp/sstate-cache
#    - "~/custom_2" # relative to the user's home directory

test:
  override:
    - mkdir -p $SSTATE_CACHE && echo "SSTATE_DIR ?= \"$SSTATE_CACHE\"" >> $BSP/meta-clanton_*/yocto_build/conf/local.conf
    - . $BSP/meta-clanton*/poky/oe-init-build-env $BSP/meta-clanton*/yocto_build && bitbake image-full-galileo

#deployment:
#  staging:
#    branch: master
#    heroku:
#      appname: foo-bar-123

teardown:
  post:
    - echo "Tearing down!"


#- sudo apt-get remove -y git
# - wget https://github.com/alan-donnelly/galileo-git/archive/1.8.1.2.tar.gz -O galileo-git-1.8.1.2.tar.gz
# - tar -xf galileo-git-1.8.1.2.tar.gz
# - cd galileo-git-1.8.1.2
# - "sed -i -e \"s/install: all/install:/\" Makefile"
# - sudo make install 
# - cd ..
# - rm -rf galileo-git-1.8.1.2
# - sudo ln -s /usr/local/bin/git /usr/bin/git
# - git --version
#

